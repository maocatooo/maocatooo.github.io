### TCP三次握手

1. 客户端发送SYN包到服务端请求建立连接, 客户端处于SYN_SEND状态,等待服务端确认,
2. 服务端接受SYN并且发送SYN + ACK包给客户端, 服务端处于SYN_RECV,
3. 客户端接受SYN + ACK, 并且发送ACK给服务端, 自此, 服务端和客户端进入established状态

建立连接的时候, 发送的包都不包含任何数据, 建立连接后才发送数据, 理想状态下, TCP一旦创建, 在通信双方中的任何一方主动关闭连接, TCP都会一直连接下去

### 四次挥手

1. 由客户端向服务器发送FIN报文, 请求断开连接, 序号为x。此时TCP数据包的标志位为FIN。
2. 服务器向客户端发送ACK报文, 表示收到了客户端发送的断开连接请求的数据包, 序号为y, 确认序号为x+1。
此时TCP数据包的标志位ACK被设置为1
3. 服务器向客户端发送FIN包, 表示服务器向客户端发送结束请求包, 序号为y, 确认序号为x+1
4. 由客户端向服务器发送ACK报文, 表示收到服务器的结束请求包, 到这里所有流程走完, 服务器与客户端, 正式断开连接, TCP数据包的序号为x+1, 确认号为y+1


![123](image/1.png)

TIME_WAIT ：TCP 四次握手结束后, 连接双方都不再交换消息, 但主动关闭的一方保持这个连接在一段时间（2MSL两个最大报文生命周期时间）内不可用。

原因：

确保最后一个确认报文能够到达（如果B没收到A发送来的确认报文, 那么就会重新发送连接释放请求报文, A等待一段时间就是为了处理这种情况的发生）
避免新旧链接混淆。（等待2MSL可以让本连接持续时间内所产生的所有报文都从网络中消失, 使得下一个新的连接请求不会出现旧的连接请求报文）



TIME_WAIT状态造成的危害
在高并发短连接的TCP服务器上, 当服务器处理完请求后主动请求关闭连接, 这样服务器上会有大量的连接处于TIME_WAIT状态, 服务器维护每一个连接需要一个socket, 也就是每个连接会占用一个文件描述符, 而文件描述符的使用是有上限的, 如果持续高并发, 会导致一些连接失败。

还有一种情况, 假设假设假设, 今天双十一, 这是一台Tmall的服务器, 因为一些原因, 服务器进程挂掉了, 退出了, 由于是服务器主动关闭连接, 因此会有TIME_WAIT状态存在, 也就意味着服务器进程想立即重启, 但是起不来, 因为端口（可能是80）还被之前处于TIME_WAIT的连接占用着, 如果TIME_WAIT状态维持60秒, 60秒服务器都起不来



#### 为什么是三次

TCP 协议的作用是, 保证数据通信的完整性和可靠性, 防止丢包

TCP作为一种可靠传输控制协议, 其核心思想：既要保证数据可靠传输, 又要提高传输的效率, 而用三次恰恰可以满足以上两方面的需求

为了实现可靠数据传输,  TCP 协议的通信双方,  都必须维护一个序列号,  以标识发送出去的数据包中,  哪些是已经被对方收到的。 三次握手的过程即是通信双方相互告知序列号起始值,  并确认对方已经收到了序列号起始值的必经步骤


#### 为什么不是两次

如果只是两次握手,  至多只有连接发起方的起始序列号能被确认,  另一方选择的序列号则得不到确认


#### tcp如何保证可靠传输

TCP主要提供了检验和、序列号/确认应答、超时重传、最大消息长度、滑动窗口控制(流量控制), 拥塞控制等方法实现了可靠性传输


### UDP

UDP是传输层的协议, 功能即为在IP的数据报服务之上增加了最基本的服务：复用和分用以及差错检测


#### tpc 和 udp 的区别?

1. TCP面向连接(如打电话要先拨号建立连接);UDP是无连接的, 即发送数据之前 不需要建立连接 
2. TCP提供可靠的服务。也就是说, 通过TCP连接传送的数据, 无差错, 不丢失,  不重复, 且按序到达;UDP尽最大努力交付, 即不保证可靠交付 
3. TCP面向字节流, 实际上是TCP把数据看成一连串无结构的字节流;UDP是面向 报文的, UDP没有拥塞控制, 因此网络出现拥塞不会使源主机的发送速率降低 
4. 每一条TCP连接只能是点到点的;UDP支持一对一, 一对多, 多对一和多对多的 交互通信 
5. TCP首部开销20字节;UDP的首部开销小, 只有8个字节 
6. TCP的逻辑通信信道是全双工的可靠信道, UDP则是不可靠信道



### OSI 七层协议

1. 应用层(数据): 确定进程之间通信的性质以满足用户需要以及提供网络与用户应用
2. 表示层(数据): 主要解决拥护信息的语法表示问题, 如加密解密
3. 会话层(数据): 提供包括访问验证和会话管理在内的建立和维护应用之间通信的机制, 如服务器验证用户登录便是由会话层完成的
4. 运输层(段): 实现网络不同主机上用户进程之间的数据通信, 可靠与不可靠的传输, 传输层的错误检测, 流量控制等
5. 网络层(包): 提供逻辑地址（IP）、选路, 数据从源端到目的端的传输
6. 数据链路层(帧): 将上层数据封装成帧, 用MAC地址访问媒介, 错误检测与修正
7. 物理层（比特流）：设备之间比特流的传输, 物理接口, 电气特性等


### TCP/IP 四层协议

1. 应用层（TELNET、FTP、SMTP、HTTP）
2. 运输层（TCP、UDP）
3. 网际层（IP、ICMP）
4. 网络接口层（PPP）


### socket

Socket是什么

Socket是应用层与TCP/IP协议族通信的中间软件抽象层, 它是一组接口。在设计模式中, Socket其实就是一个门面模式, 它把复杂的TCP/IP协议族隐藏在Socket接口后面, 对用户来说, 一组简单的接口就是全部, 让Socket去组织数据, 以符合指定的协议

![socket](./image/2.png)

Socket=Ip address+ TCP/UDP + port